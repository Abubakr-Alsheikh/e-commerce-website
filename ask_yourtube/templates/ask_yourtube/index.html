{% extends 'ask_yourtube/base.html' %}
{% block title %}AskVid - AI Video Q&A{% endblock %}
{% block content %}

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm bg-secondary text-light">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">AskVid: Get Answers from Videos</h2>
                    <p class="card-text text-center text-light-500">
                        Have questions about a video? AskVid's AI will find the answers for you.
                        Just upload your video below and type your question.
                    </p>

                    <div class="input-group mb-3" id="videoUploadGroup">
                        <input type="file" class="form-control" id="videoFile" accept="video/*, audio/*" aria-label="Upload Video" aria-describedby="video-upload-label">
                        <button id="uploadVideoButton" class="btn btn-primary">Upload Video</button>
                    </div>
                    
                    <div id="processingMessage" style="display: none;">Processing, please wait...</div> 
                    
                    <div id="videoFrame" style="display:none; min-width: 100%;">
                        <video id="uploadedVideo" controls></video>
                    </div>

                    <div id="videoSummary" class="mt-4 text-muted" style="display:none;">
                        <h3 class="mb-3">Video Summary</h3>
                        <p id="summaryContent"></p>
                    </div>

                    <div id="chatForm" class="mt-4" style="display:none;">
                        <h3 class="mb-3">Ask Your Question</h3>
                        <div class="card shadow-sm bg-light text-dark">
                            <div class="card-body">
                                <div id="chatContainer">
                                    <div id="chatMessages">
                                        <!-- Chat messages will go here -->
                                    </div>
                                    <div class="input-group mt-2">
                                        <input id="questionInput" type="text" class="form-control" placeholder="Type your question..." aria-label="Your Question" aria-describedby="question-label">
                                        <button id="askQuestionButton" class="btn btn-primary">Send</button>
                                    </div>
                                    <div id="questionProcessingMessage" style="display: none; margin-top: 10px;">Processing, please wait...</div> 
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="session-id" value="">

                </div>
            </div>
        </div>
    </div>

    <script>
        function getUserID() {
            let userID = localStorage.getItem('userID');
            if (!userID) {
                userID = generateUUID(); 
                localStorage.setItem('userID', userID);
            }
            return userID;
        }

        // Function to generate a UUID (you can use a library if needed)
        function generateUUID() { 
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        document.getElementById('uploadVideoButton').addEventListener('click', async () => {
            const videoFile = document.getElementById('videoFile').files[0];
            const videoSummary = document.getElementById('videoSummary');
            const chatForm = document.getElementById('chatForm');
            const videoFrame = document.getElementById('videoFrame');
            const videoUploadGroup = document.getElementById('videoUploadGroup');
            const summaryContent = document.getElementById('summaryContent');
            const uploadedVideo = document.getElementById('uploadedVideo'); 
            const sessionIdInput = document.getElementById('session-id');
            const uploadVideoButton = document.getElementById('uploadVideoButton');
            const processingMessage = document.getElementById('processingMessage');
            const userID = getUserID(); // Get user ID

            if (videoFile) {
                if (videoFile.size > 10485760) { // 10MB limit
                    alert("File size too large. Please select a video or audio file smaller than 10MB.");
                    return; 
                }

                // Disable the button and show processing message
                uploadVideoButton.disabled = true;
                processingMessage.style.display = 'block';

                try {
                    const formData = new FormData();
                    formData.append('video', videoFile);
                    formData.append('user_id', userID);

                    // Fetch video summary from the backend
                    const endpointUrl = "{% url 'ask-yourtube:analyze-video' %}";
                    const response = await fetch(endpointUrl, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    // Update UI
                    summaryContent.textContent = data.summary;
                    videoSummary.style.display = 'block';
                    chatForm.style.display = 'block';
                    videoFrame.style.display = 'block';
                    videoUploadGroup.style.display = 'none';

                    // Set the source for the video element
                    uploadedVideo.src = URL.createObjectURL(videoFile);

                    // Store the session ID in the input field
                    sessionIdInput.value = data.session_id;

                } catch (error) {
                    console.error("Error occurred:", error);
                    alert("Something went wrong. Please try again later.");
                } finally {
                    // Re-enable the button and hide processing message
                    uploadVideoButton.disabled = false;
                    processingMessage.style.display = 'none';
                }

            } else {
                alert("Please select a video or audio file.");
            }
        });


        document.getElementById('askQuestionButton').addEventListener('click', async () => {
            const questionInput = document.getElementById('questionInput');
            const question = questionInput.value;
            const sessionIdInput = document.getElementById('session-id');
            const sessionId = sessionIdInput.value;
            const chatMessages = document.getElementById('chatMessages');
            const askQuestionButton = document.getElementById('askQuestionButton');
            const questionProcessingMessage = document.getElementById('questionProcessingMessage');

            if (question) {
                // Disable the button and show processing message
                askQuestionButton.disabled = true;
                questionProcessingMessage.style.display = 'block';


                try {
                    // Fetch answer from the backend
                    const endpointUrl = "{% url 'ask-yourtube:ask-question' %}";
                    const response = await fetch(endpointUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ question: question, session_id: sessionId })
                    });
                    const data = await response.json();

                    // Display the answer
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('message');
                    messageDiv.innerHTML = `
                        <p class="text-light bg-secondary p-2 rounded mb-1"><strong>You:</strong> ${question}</p>
                        <p class="text-dark bg-light p-2 rounded mb-1"><strong>AskVid:</strong> ${data.answer}</p>
                    `;
                    chatMessages.appendChild(messageDiv);
                    
                } catch (error) {
                    console.error("Error occurred:", error);
                    alert("Something went wrong. Please try again later.");
                } finally {
                    // Re-enable the button and hide processing message
                    askQuestionButton.disabled = false;
                    questionInput.value = '';
                    questionProcessingMessage.style.display = 'none'; 
                }
            } else {
                alert("Please enter a question.");
            }
        });
    </script>

{% endblock %}