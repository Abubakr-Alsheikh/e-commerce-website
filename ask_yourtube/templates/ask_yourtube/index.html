{% extends 'ask_yourtube/base.html' %}
{% block title %}AskVid - AI Video Q&A{% endblock %}
{% block content %}

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm bg-secondary text-light">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">AskVid: Get Answers from Videos</h2>
                    <p class="card-text text-center text-light-500">
                        Have questions about a YouTube video? AskVid's AI will find the answers for you.
                        Just paste the video link below and type your question.
                    </p>

                    <div class="input-group mb-3" id="videoLinkGroup">
                        
                        <input id="youtubeLink" type="url" class="form-control" placeholder="Paste YouTube Link..." aria-label="Video Link" aria-describedby="video-link-label">
                        <button id="analyzeVideoButton" class="btn btn-primary">Analyze Video</button>
                    </div>
                    <div id="processingMessage" style="display: none;">Processing, please wait...</div> <div id="videoFrame" style="display:none;">
                        <iframe id="youtubeIframe" width="560" height="315" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>

                    <div id="videoSummary" class="mt-4 text-muted" style="display:none;">
                        <h3 class="mb-3">Video Summary</h3>
                        <p id="summaryContent"></p>
                    </div>

                    <div id="chatForm" class="mt-4" style="display:none;">
                        <h3 class="mb-3">Ask Your Question</h3>
                        <div class="card shadow-sm bg-light text-dark">
                            <div class="card-body">
                                <div id="chatContainer">
                                    <div id="chatMessages">
                                        <!-- Chat messages will go here -->
                                    </div>
                                    <div class="input-group mt-2">
                                        <input id="questionInput" type="text" class="form-control" placeholder="Type your question..." aria-label="Your Question" aria-describedby="question-label">
                                        <button id="askQuestionButton" class="btn btn-primary">Send</button>
                                    </div>
                                    <div id="questionProcessingMessage" style="display: none; margin-top: 10px;">Processing, please wait...</div> 
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="session-id" value="">

                </div>
            </div>
        </div>
    </div>

    <script>
         function getUserID() {
            let userID = localStorage.getItem('userID');
            if (!userID) {
                userID = generateUUID(); 
                localStorage.setItem('userID', userID);
            }
            return userID;
        }

        // Function to generate a UUID (you can use a library if needed)
        function generateUUID() { 
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        document.getElementById('analyzeVideoButton').addEventListener('click', async () => {
            const youtubeLink = document.getElementById('youtubeLink').value;
            const videoSummary = document.getElementById('videoSummary');
            const chatForm = document.getElementById('chatForm');
            const videoFrame = document.getElementById('videoFrame');
            const videoLinkGroup = document.getElementById('videoLinkGroup');
            const summaryContent = document.getElementById('summaryContent');
            const youtubeIframe = document.getElementById('youtubeIframe');
            const sessionIdInput = document.getElementById('session-id');
            const analyzeVideoButton = document.getElementById('analyzeVideoButton');
            const processingMessage = document.getElementById('processingMessage');
            const userID = getUserID(); // Get user ID

            if (youtubeLink) {
                // Disable the button and show processing message
                analyzeVideoButton.disabled = true;
                processingMessage.style.display = 'block';

                try {
                    // Fetch video summary from the backend
                    const endpointUrl = "{% url 'ask-yourtube:analyze-video' %}";
                    const response = await fetch(endpointUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ link: youtubeLink, user_id: userID })
                    });
                    const data = await response.json();

                    // Update UI
                    summaryContent.textContent = data.summary;
                    videoSummary.style.display = 'block';
                    chatForm.style.display = 'block';
                    videoFrame.style.display = 'block';
                    videoLinkGroup.style.display = 'none';
                    youtubeIframe.src = `https://www.youtube.com/embed/${youtubeLink.split('v=')[1]}`;

                    // Store the session ID in the input field
                    sessionIdInput.value = data.session_id;

                } catch (error) {
                    console.error("Error occurred:", error);
                    alert("Something went wrong. Please try again later.");
                } finally {
                    // Re-enable the button and hide processing message
                    analyzeVideoButton.disabled = false;
                    processingMessage.style.display = 'none';
                }

            } else {
                alert("Please enter a YouTube link.");
            }
        });

        document.getElementById('askQuestionButton').addEventListener('click', async () => {
            const questionInput = document.getElementById('questionInput');
            const question = questionInput.value;
            const sessionIdInput = document.getElementById('session-id');
            const sessionId = sessionIdInput.value;
            const chatMessages = document.getElementById('chatMessages');
            const askQuestionButton = document.getElementById('askQuestionButton');
            const questionProcessingMessage = document.getElementById('questionProcessingMessage');

            if (question) {
                // Disable the button and show processing message
                askQuestionButton.disabled = true;
                questionProcessingMessage.style.display = 'block';


                try {
                    // Fetch answer from the backend
                    const endpointUrl = "{% url 'ask-yourtube:ask-question' %}";
                    const response = await fetch(endpointUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ question: question, session_id: sessionId })
                    });
                    const data = await response.json();

                    // Display the answer
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('message');
                    messageDiv.innerHTML = `
                        <p class="text-light bg-secondary p-2 rounded mb-1"><strong>You:</strong> ${question}</p>
                        <p class="text-dark bg-light p-2 rounded mb-1"><strong>AskVid:</strong> ${data.answer}</p>
                    `;
                    chatMessages.appendChild(messageDiv);
                    
                } catch (error) {
                    console.error("Error occurred:", error);
                    alert("Something went wrong. Please try again later.");
                } finally {
                    // Re-enable the button and hide processing message
                    askQuestionButton.disabled = false;
                    questionInput.value = '';
                    questionProcessingMessage.style.display = 'none'; 
                }
            } else {
                alert("Please enter a question.");
            }
        });
    </script>

{% endblock %}